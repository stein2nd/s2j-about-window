name: Docs Linter

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docs-linter:
    runs-on: ubuntu-latest
    env:
      # docs-linter のディレクトリパス
      DOCS_LINTER_DIR: tools/docs-linter
      # プロジェクトルート（GitHub Actions のワークスペース）
      PROJECT_ROOT: ${{ github.workspace }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: tools/docs-linter/package-lock.json

    - name: Install dependencies
      run: |
        cd "$DOCS_LINTER_DIR"
        npm ci
        npm run build

    - name: Show textlint config
      run: |
        shopt -s globstar nullglob
        # 対象ファイルを1つ選んで設定を確認（docs-linterディレクトリからの相対パス）
        TARGET_FILE=""
        if [ -f ../../README.md ]; then
          TARGET_FILE="../../README.md"
        elif [ -d ../../docs ]; then
          # 最初に見つかったMarkdownファイルを使用
          for file in ../../docs/**/*.md; do
            if [ -f "$file" ]; then
              TARGET_FILE="$file"
              break
            fi
          done
        fi
        if [ -n "$TARGET_FILE" ]; then
          echo "=== Debug extends resolving ==="
          NODE_PATH=./node_modules npx textlint --debug --config ./swift/.textlintrc.swift.json "$TARGET_FILE" || true
        fi
      working-directory: ${{ env.DOCS_LINTER_DIR }}

    - name: Run docs linter
      run: |
        shopt -s globstar nullglob
        
        # 対象ファイルのパスを調整（docs-linterディレクトリからの相対パス）
        # docs-linterディレクトリは tools/docs-linter なので、プロジェクトルートへの相対パスは ../../
        LINT_TARGETS=()
        if [ -f ../../README.md ]; then
          LINT_TARGETS+=("../../README.md")
        fi
        if [ -d ../../docs ]; then
          for file in ../../docs/**/*.md; do
            [ -f "$file" ] && LINT_TARGETS+=("$file")
          done
        fi
        
        if [ ${#LINT_TARGETS[@]} -eq 0 ]; then
          echo "No target files found"
          exit 0
        fi
        
        echo "=== START textlint ==="
        echo "Target files: ${LINT_TARGETS[*]}"
        
        # package.jsonのlint:swiftスクリプトと同じように実行
        # NODE_PATH=./node_modules を設定することで、ルールパッケージが見つけられるようになる
        # extends は設定ファイル（swift/.textlintrc.swift.json）基準で解決されるため、
        # 実行対象のMarkdownのパスは docs-linter/ からの相対パスにする必要がある
        NODE_PATH=./node_modules npx textlint --config ./swift/.textlintrc.swift.json "${LINT_TARGETS[@]}"
      working-directory: ${{ env.DOCS_LINTER_DIR }}

    - name: Log summary
      if: always()
      run: |
        echo "=== textlint finished ==="
        echo "Exit code: $?"
