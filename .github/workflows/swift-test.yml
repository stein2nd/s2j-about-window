name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on macOS
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: macos
        name: macos-coverage

  test-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Verify Swift Package
      run: |
        swift package describe --type json | head -20
        swift package resolve

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode Project
      run: |
        if [ -f "project.yml" ]; then
          echo "Generating Xcode project from project.yml..."
          xcodegen generate
          echo "Xcode project generated successfully"
        else
          echo "Error: project.yml not found. Cannot generate Xcode project."
          exit 1
        fi

    - name: List available simulators
      run: |
        echo "Available iOS simulators:"
        xcrun simctl list devices available | grep -i "iOS" || true

    - name: Get iOS Simulator Destination
      id: simulator
      run: |
        # Use xcodebuild -showdestinations to get available destinations for the scheme
        # This ensures we get destinations that xcodebuild can actually use
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Querying available destinations for S2JAboutWindow-iOS scheme..."
          # Capture both stdout and stderr, but filter for iOS Simulator destinations
          # xcodebuild outputs destinations to stdout, errors to stderr
          DESTINATIONS=$(xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>/dev/null | grep "platform=iOS Simulator" | head -1)
          if [ -z "$DESTINATIONS" ]; then
            echo "Error: No iOS Simulator destinations found"
            echo "Trying to list all destinations (including errors)..."
            xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>&1 | head -20 || true
            exit 1
          fi
          echo "Found destination: $DESTINATIONS"
          # Extract UDID from destination string (format: platform=iOS Simulator,id=...)
          SIMULATOR_UDID=$(echo "$DESTINATIONS" | grep -oE 'id=[A-F0-9-]+' | cut -d= -f2 | head -1)
          if [ -z "$SIMULATOR_UDID" ]; then
            # If no UDID found, try to use name-based destination
            SIMULATOR_NAME=$(echo "$DESTINATIONS" | grep -oE 'name=[^,]+' | cut -d= -f2 | head -1)
            if [ -n "$SIMULATOR_NAME" ]; then
              echo "Using name-based destination: platform=iOS Simulator,name=$SIMULATOR_NAME"
              echo "destination=platform=iOS Simulator,name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
            else
              echo "Error: Could not extract simulator identifier from destination"
              echo "Full destination string: $DESTINATIONS"
              exit 1
            fi
          else
            echo "Using UDID-based destination: platform=iOS Simulator,id=$SIMULATOR_UDID"
            echo "destination=platform=iOS Simulator,id=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          fi
        else
          echo "Error: Xcode project not found"
          exit 1
        fi

    - name: List Xcode schemes
      run: |
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          xcodebuild -list -project s2j-about-window.xcodeproj
        else
          echo "Error: Xcode project not found after generation"
          exit 1
        fi

    - name: Build for iOS (verify compilation)
      run: |
        # Get iOS SDK path
        IOS_SDK_PATH=$(xcrun --show-sdk-path --sdk iphonesimulator)
        echo "iOS SDK Path: $IOS_SDK_PATH"

        # Use destination from previous step
        DESTINATION="${{ steps.simulator.outputs.destination }}"
        echo "Using destination: $DESTINATION"

        # Build with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Building with Xcode project..."
          xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -destination "$DESTINATION" \
            -sdk iphonesimulator
        else
          echo "Error: Xcode project not found. iOS builds require an Xcode project."
          exit 1
        fi

    - name: Run tests on iOS Simulator
      run: |
        set -e
        # Use destination from previous step
        DESTINATION="${{ steps.simulator.outputs.destination }}"
        echo "Using destination: $DESTINATION"

        # Run tests with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Running tests with Xcode project..."
          xcodebuild test \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -destination "$DESTINATION" \
            -enableCodeCoverage YES
        else
          echo "Error: Xcode project not found. iOS tests require an Xcode project."
          exit 1
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: ios
        name: ios-coverage
        fail_ci_if_error: false

  build-release:
    runs-on: macos-latest
    needs: [test-macos, test-ios]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build Universal Binary
      run: |
        swift build -c release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: s2j-about-window-build
        path: .build/release/
