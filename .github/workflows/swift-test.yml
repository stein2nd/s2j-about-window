name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on macOS
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: macos
        name: macos-coverage

  test-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Verify Swift Package
      run: |
        swift package describe --type json | head -20
        swift package resolve

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode Project
      run: |
        if [ -f "project.yml" ]; then
          echo "Generating Xcode project from project.yml..."
          xcodegen generate
          echo "Xcode project generated successfully"
          echo ""
          echo "=== Verifying scheme configuration ==="
          if [ -f "s2j-about-window.xcodeproj/xcshareddata/xcschemes/S2JAboutWindow-iOS.xcscheme" ]; then
            echo "Scheme file exists, checking test destination..."
            echo "--- TestAction section ---"
            grep -A 20 "TestAction" s2j-about-window.xcodeproj/xcshareddata/xcschemes/S2JAboutWindow-iOS.xcscheme | head -30 || echo "TestAction not found"
            echo ""
            echo "--- LaunchAction section ---"
            grep -A 20 "LaunchAction" s2j-about-window.xcodeproj/xcshareddata/xcschemes/S2JAboutWindow-iOS.xcscheme | head -30 || echo "LaunchAction not found"
            echo ""
            echo "--- Full scheme file (first 100 lines) ---"
            head -100 s2j-about-window.xcodeproj/xcshareddata/xcschemes/S2JAboutWindow-iOS.xcscheme
          else
            echo "Warning: Scheme file not found at expected location"
            echo "Looking for scheme files..."
            find s2j-about-window.xcodeproj -name "*.xcscheme" -type f || echo "No scheme files found"
          fi
        else
          echo "Error: project.yml not found. Cannot generate Xcode project."
          exit 1
        fi

    - name: List available simulators
      run: |
        echo "Available iOS simulators:"
        xcrun simctl list devices available | grep -i "iOS" || true

    - name: Get and Boot iOS Simulator
      id: simulator
      run: |
        # First, generate the Xcode project if it doesn't exist
        if [ ! -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Xcode project not found, generating it..."
          if [ -f "project.yml" ]; then
            xcodegen generate
          else
            echo "Error: project.yml not found"
            exit 1
          fi
        fi

        # Get available iOS simulators and boot one
        echo "Listing available iOS simulators..."
        xcrun simctl list devices available | grep -i "iPhone\|iPad" | head -10 || true

        # Try to find an iPhone simulator first, then iPad
        SIMULATOR_LINE=$(xcrun simctl list devices available | grep -i "iPhone" | head -1)
        if [ -z "$SIMULATOR_LINE" ]; then
          SIMULATOR_LINE=$(xcrun simctl list devices available | grep -i "iPad" | head -1)
        fi

        if [ -z "$SIMULATOR_LINE" ]; then
          echo "Error: No available iOS simulator found"
          echo "All available devices:"
          xcrun simctl list devices available || true
          exit 1
        fi

        echo "Found simulator line: $SIMULATOR_LINE"

        # Extract UDID
        SIMULATOR_UDID=$(echo "$SIMULATOR_LINE" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)

        # Extract simulator name (e.g., "iPhone 15" or "iPhone 15 Pro")
        # Format: "iPhone 15 (A95FF35F-...) (Available)"
        SIMULATOR_NAME=$(echo "$SIMULATOR_LINE" | sed -E 's/^[[:space:]]*([^(]+) \(.*/\1/' | xargs)

        echo "Found iOS Simulator: $SIMULATOR_NAME (UDID: $SIMULATOR_UDID)"

        # Boot the simulator (if not already booted)
        echo "Checking simulator status..."
        CURRENT_STATUS=$(xcrun simctl list devices | grep "$SIMULATOR_UDID" | grep -oE '\([^)]+\)' | head -1 | sed 's/[()]//g' || echo "")

        if [ "$CURRENT_STATUS" != "Booted" ]; then
          echo "Booting simulator $SIMULATOR_UDID..."
          xcrun simctl boot "$SIMULATOR_UDID" 2>&1 || echo "Boot command completed (may already be booting)"

          # Open Simulator app to ensure it's fully initialized
          echo "Opening Simulator app..."
          open -a Simulator || true

          # Wait for simulator to be ready with polling
          echo "Waiting for simulator to be ready..."
          MAX_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            BOOT_STATUS=$(xcrun simctl list devices | grep "$SIMULATOR_UDID" | grep -o "Booted" || echo "")
            if [ -n "$BOOT_STATUS" ]; then
              echo "Simulator is booted"
              break
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "Waiting for simulator to boot... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done

          if [ -z "$BOOT_STATUS" ]; then
            echo "Error: Simulator failed to boot after $MAX_ATTEMPTS attempts"
            exit 1
          fi
        else
          echo "Simulator is already booted"
        fi

        # Wait for simulator to be fully ready and accessible via xcodebuild
        echo "Waiting for simulator to be accessible via xcodebuild..."
        MAX_ATTEMPTS=10
        ATTEMPT=0
        XCODE_DEST=""

        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ -z "$XCODE_DEST" ]; do
          # Query xcodebuild for available destinations
          DEST_OUTPUT=$(xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>&1 || true)

          # Try to find destination with UDID first (most reliable)
          if [ -n "$SIMULATOR_UDID" ]; then
            XCODE_DEST=$(echo "$DEST_OUTPUT" | grep "platform=iOS Simulator" | grep "$SIMULATOR_UDID" | head -1 || echo "")
            if [ -n "$XCODE_DEST" ]; then
              echo "Found destination by UDID: $XCODE_DEST"
              break
            fi
          fi

          # If not found by UDID, try by name
          if [ -z "$XCODE_DEST" ] && [ -n "$SIMULATOR_NAME" ]; then
            XCODE_DEST=$(echo "$DEST_OUTPUT" | grep -i "platform=iOS Simulator" | grep -i "$SIMULATOR_NAME" | head -1 || echo "")
            if [ -n "$XCODE_DEST" ]; then
              echo "Found destination by name: $XCODE_DEST"
              break
            fi
          fi

          # If still not found, try to get any available iOS Simulator destination
          if [ -z "$XCODE_DEST" ]; then
            XCODE_DEST=$(echo "$DEST_OUTPUT" | grep "platform=iOS Simulator" | head -1 || echo "")
            if [ -n "$XCODE_DEST" ]; then
              echo "Found any available iOS Simulator destination: $XCODE_DEST"
              # Extract UDID from the found destination
              FOUND_UDID=$(echo "$XCODE_DEST" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
              if [ -n "$FOUND_UDID" ]; then
                SIMULATOR_UDID="$FOUND_UDID"
                echo "Updated UDID to: $SIMULATOR_UDID"
              fi
              break
            fi
          fi

          if [ -z "$XCODE_DEST" ]; then
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -eq 1 ] || [ $((ATTEMPT % 5)) -eq 0 ]; then
              echo "Waiting for simulator to be accessible via xcodebuild... ($ATTEMPT/$MAX_ATTEMPTS)"
              echo "Debug: xcodebuild output (first 30 lines):"
              echo "$DEST_OUTPUT" | head -30 || true
              echo "Debug: Simulator status:"
              xcrun simctl list devices | grep "$SIMULATOR_UDID" || true
            else
              echo "Waiting for simulator to be accessible via xcodebuild... ($ATTEMPT/$MAX_ATTEMPTS)"
            fi
            sleep 2
          fi
        done

        # If xcodebuild still doesn't return destinations, construct destination manually
        if [ -z "$XCODE_DEST" ]; then
          echo "Warning: xcodebuild -showdestinations did not return iOS Simulator destinations after $MAX_ATTEMPTS attempts"
          echo "Full xcodebuild output (last attempt):"
          echo "$DEST_OUTPUT"
          echo ""
          echo "Attempting to construct destination manually from simulator info..."

          # Verify simulator is still booted
          SIMULATOR_LINE=$(xcrun simctl list devices | grep "$SIMULATOR_UDID" | head -1 || echo "")
          if echo "$SIMULATOR_LINE" | grep -q "Booted"; then
            echo "Simulator is booted, constructing destination string manually..."
            echo "Simulator line: $SIMULATOR_LINE"
            # Construct destination string manually: prefer id=UDID only (more reliable)
            # Format: platform=iOS Simulator,id=UDID
            if [ -n "$SIMULATOR_UDID" ]; then
              XCODE_DEST="platform=iOS Simulator,id=$SIMULATOR_UDID"
              echo "Constructed destination: $XCODE_DEST"
            else
              echo "Error: Cannot construct destination - missing UDID"
              echo "Available destinations:"
              xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>&1 || true
              exit 1
            fi
          else
            echo "Error: Simulator is not booted"
            echo "Simulator line: $SIMULATOR_LINE"
            echo "Available destinations:"
            xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>&1 || true
            exit 1
          fi
        fi

        # Use the destination found via xcodebuild or constructed manually
        DEST_STRING=$(echo "$XCODE_DEST" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
        echo "Using destination: $DEST_STRING"
        echo "destination=$DEST_STRING" >> $GITHUB_OUTPUT
        echo "udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
        echo "name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT

    - name: List Xcode schemes
      run: |
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          xcodebuild -list -project s2j-about-window.xcodeproj
        else
          echo "Error: Xcode project not found after generation"
          exit 1
        fi

    - name: Debug xcodebuild destinations
      run: |
        set -x
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "=== Checking available simulators ==="
          xcrun simctl list devices available | head -20 || true
          echo ""
          echo "=== Checking scheme file for TestAction destination ==="
          if [ -f "s2j-about-window.xcodeproj/xcshareddata/xcschemes/S2JAboutWindow-iOS.xcscheme" ]; then
            echo "Looking for destination in TestAction..."
            grep -A 30 "TestAction" s2j-about-window.xcodeproj/xcshareddata/xcschemes/S2JAboutWindow-iOS.xcscheme | grep -i "destination\|platform" || echo "No destination found in TestAction"
          fi
          echo ""
          echo "=== Full xcodebuild -showdestinations output (with SDK) ==="
          DEST_OUTPUT=$(xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>&1)
          echo "$DEST_OUTPUT"
          echo "$DEST_OUTPUT" > /tmp/destinations-with-sdk.txt || true
          echo ""
          echo "=== Full xcodebuild -showdestinations output (without SDK) ==="
          DEST_OUTPUT_NO_SDK=$(xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations 2>&1)
          echo "$DEST_OUTPUT_NO_SDK"
          echo "$DEST_OUTPUT_NO_SDK" > /tmp/destinations-without-sdk.txt || true
          echo ""
          echo "=== Checking scheme build destinations ==="
          echo "$DEST_OUTPUT_NO_SDK" | grep -i "simulator" || echo "No simulator destinations found"
          echo ""
          echo "=== Checking scheme test destinations ==="
          echo "$DEST_OUTPUT" | grep -i "simulator" || echo "No simulator destinations found for test"
          echo ""
          echo "=== Checking scheme configuration ==="
          xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showBuildSettings 2>&1 | grep -i "sdk\|platform" | head -10 || true
          echo "=== End of destinations output ==="
        else
          echo "Error: Xcode project not found"
          exit 1
        fi

    - name: Build for iOS (verify compilation)
      run: |
        set -e
        # Get iOS SDK path
        IOS_SDK_PATH=$(xcrun --show-sdk-path --sdk iphonesimulator)
        echo "iOS SDK Path: $IOS_SDK_PATH"

        # Build with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Building with Xcode project..."

          # Try multiple approaches
          # Approach 1: Try building target directly (no scheme)
          echo "=== Attempting build with target directly (no scheme) ==="
          set +e
          if xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -target S2JAboutWindow-iOS \
            -sdk iphonesimulator \
            -arch arm64 2>&1; then
            echo "✅ Build succeeded with target directly (arm64)"
            exit 0
          elif xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -target S2JAboutWindow-iOS \
            -sdk iphonesimulator \
            -arch x86_64 2>&1; then
            echo "✅ Build succeeded with target directly (x86_64)"
            exit 0
          else
            echo "❌ Build failed with target directly, trying with scheme..."
            set -e
          fi

          # Approach 2: Try with SDK and architecture (no destination)
          echo "=== Attempting build with SDK and architecture (no destination) ==="
          set +e
          if xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -sdk iphonesimulator \
            -arch arm64 2>&1; then
            echo "✅ Build succeeded with SDK and arm64 architecture"
            exit 0
          elif xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -sdk iphonesimulator \
            -arch x86_64 2>&1; then
            echo "✅ Build succeeded with SDK and x86_64 architecture"
            exit 0
          else
            echo "❌ Build failed with SDK and architecture, trying with destination..."
            set -e
          fi

          # Approach 3: Try with destination from previous step
          DESTINATION="${{ steps.simulator.outputs.destination }}"
          if [ -n "$DESTINATION" ]; then
            echo "=== Attempting build with destination: $DESTINATION ==="
            set +e
            if xcodebuild build \
              -project s2j-about-window.xcodeproj \
              -scheme S2JAboutWindow-iOS \
              -destination "$DESTINATION" \
              -sdk iphonesimulator 2>&1; then
              echo "✅ Build succeeded with specific destination"
              exit 0
            else
              echo "❌ Build failed with specific destination, trying generic destination..."
              set -e
            fi
          fi

          # Approach 4: Try with generic platform destination
          echo "=== Attempting build with generic platform destination ==="
          xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -destination "platform=iOS Simulator" \
            -sdk iphonesimulator
        else
          echo "Error: Xcode project not found. iOS builds require an Xcode project."
          exit 1
        fi

    - name: Run tests on iOS Simulator
      run: |
        set -e
        # Run tests with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Running tests with Xcode project..."

          # Get simulator information from previous step
          DESTINATION="${{ steps.simulator.outputs.destination }}"
          SIMULATOR_UDID="${{ steps.simulator.outputs.udid }}"
          SIMULATOR_NAME="${{ steps.simulator.outputs.name }}"

          if [ -z "$DESTINATION" ]; then
            echo "Warning: Destination not found from simulator step"
            echo "Attempting to reconstruct destination from simulator info..."

            # Try to get UDID and name from previous step outputs
            if [ -z "$SIMULATOR_UDID" ]; then
              echo "Error: Simulator UDID not found from simulator step"
              echo "Attempting to get destination from xcodebuild..."
              DEST_OUTPUT=$(xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>&1 || true)
              DESTINATION=$(echo "$DEST_OUTPUT" | grep "platform=iOS Simulator" | head -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' || echo "")

              if [ -z "$DESTINATION" ]; then
                echo "Error: No iOS Simulator destination found"
                echo "Available destinations:"
                echo "$DEST_OUTPUT" | grep "platform=" || true
                exit 1
              fi
              echo "Found destination: $DESTINATION"
            else
              # Reconstruct destination from UDID (prefer id=UDID only, more reliable)
              if [ -n "$SIMULATOR_UDID" ]; then
                DESTINATION="platform=iOS Simulator,id=$SIMULATOR_UDID"
              else
                echo "Error: Cannot reconstruct destination - missing UDID"
                exit 1
              fi
              echo "Reconstructed destination: $DESTINATION"
            fi
          else
            echo "Using destination from simulator step: $DESTINATION"
          fi

          # Verify simulator is still booted (instead of relying on xcodebuild -showdestinations)
          echo "Verifying simulator is still booted..."
          if [ -n "$SIMULATOR_UDID" ]; then
            SIMULATOR_LINE=$(xcrun simctl list devices | grep "$SIMULATOR_UDID" | head -1 || echo "")
            if echo "$SIMULATOR_LINE" | grep -q "Booted"; then
              echo "Simulator is booted: $SIMULATOR_LINE"
            else
              echo "Warning: Simulator may not be booted, but continuing with destination: $DESTINATION"
              echo "Simulator line: $SIMULATOR_LINE"
            fi
          else
            echo "Warning: Simulator UDID not available, skipping boot verification"
          fi

          # Build test target first (for faster test execution)
          echo "=== Building test target ==="
          TEST_BUILD_SUCCESS=false
          set +e
          if xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -target S2JAboutWindowTests-iOS \
            -sdk iphonesimulator \
            -arch arm64 2>&1; then
            echo "✅ Test target built successfully (arm64)"
            TEST_BUILD_SUCCESS=true
          elif xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -target S2JAboutWindowTests-iOS \
            -sdk iphonesimulator \
            -arch x86_64 2>&1; then
            echo "✅ Test target built successfully (x86_64)"
            TEST_BUILD_SUCCESS=true
          else
            echo "⚠️  Test target build failed, will build during test execution"
          fi
          set -e

          # Run tests with the verified destination
          echo "=== Running tests with destination: $DESTINATION ==="

          # Ensure destination uses id=UDID format (remove name= if present)
          if echo "$DESTINATION" | grep -q "name="; then
            echo "Removing name= from destination string for better compatibility..."
            DESTINATION=$(echo "$DESTINATION" | sed 's/,name=[^,]*//' | sed 's/name=[^,]*,\?//')
            echo "Updated destination: $DESTINATION"
          fi

          # Try multiple approaches to run tests
          set +e
          TEST_SUCCESS=false

          if [ "$TEST_BUILD_SUCCESS" = true ]; then
            # Approach 1: Use test-without-building if we successfully built the test target
            echo "Attempting test-without-building (test target already built)..."
            if xcodebuild test-without-building \
              -project s2j-about-window.xcodeproj \
              -scheme S2JAboutWindow-iOS \
              -destination "$DESTINATION" \
              -enableCodeCoverage YES 2>&1; then
              echo "✅ Tests passed with test-without-building"
              TEST_SUCCESS=true
            else
              echo "⚠️  test-without-building failed, trying test (build and test together)..."
            fi
          fi

          if [ "$TEST_SUCCESS" = false ]; then
            # Approach 2: Build and test together
            echo "Building and testing together..."
            if xcodebuild test \
              -project s2j-about-window.xcodeproj \
              -scheme S2JAboutWindow-iOS \
              -destination "$DESTINATION" \
              -enableCodeCoverage YES 2>&1; then
              echo "✅ Tests passed with test (build and test together)"
              TEST_SUCCESS=true
            else
              echo "❌ Tests failed with both approaches"
            fi
          fi

          set -e

          if [ "$TEST_SUCCESS" = false ]; then
            echo "Error: All test execution approaches failed"
            exit 1
          fi
        else
          echo "Error: Xcode project not found. iOS tests require an Xcode project."
          exit 1
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: ios
        name: ios-coverage
        fail_ci_if_error: false

  build-release:
    runs-on: macos-latest
    needs: [test-macos, test-ios]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build Universal Binary
      run: |
        swift build -c release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: s2j-about-window-build
        path: .build/release/
