name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on macOS
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: macos
        name: macos-coverage

  test-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Verify Swift Package
      run: |
        swift package describe --type json | head -20
        swift package resolve

    - name: List available simulators
      run: |
        xcrun simctl list devices available | grep -i "iPad Pro"

    - name: Find and boot iOS Simulator
      run: |
        DEVICE=$(xcrun simctl list devices available | grep -i "iPad Pro" | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
        if [ -z "$DEVICE" ]; then
          echo "No iPad Pro simulator found, creating one..."
          xcrun simctl create "iPad Pro Test" "iPad Pro (12.9-inch) (6th generation)" "iOS17.5" || true
          DEVICE=$(xcrun simctl list devices available | grep -i "iPad Pro" | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
        fi
        echo "Using device: $DEVICE"
        xcrun simctl boot "$DEVICE" || true
        echo "DEVICE_UDID=$DEVICE" >> $GITHUB_ENV

    - name: Build for iOS (verify compilation)
      run: |
        # Get iOS SDK path
        IOS_SDK_PATH=$(xcrun --show-sdk-path --sdk iphonesimulator)
        echo "iOS SDK Path: $IOS_SDK_PATH"

        # Try building with xcodebuild first (preferred method)
        if xcodebuild build -package . -scheme s2j-about-window -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)' -sdk iphonesimulator 2>&1; then
          echo "Build succeeded using xcodebuild with package"
        elif xcodebuild build -scheme s2j-about-window -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)' -sdk iphonesimulator 2>&1; then
          echo "Build succeeded using xcodebuild with scheme"
        else
          echo "xcodebuild failed, trying swift build with iOS target..."
          # Fallback to swift build with explicit SDK and target
          swift build -Xswiftc -sdk -Xswiftc "$IOS_SDK_PATH" -Xswiftc -target -Xswiftc arm64-apple-ios15.0-simulator || \
          swift build -Xswiftc -sdk -Xswiftc "$IOS_SDK_PATH" -Xswiftc -target -Xswiftc x86_64-apple-ios15.0-simulator
        fi

    - name: List Xcode schemes
      run: |
        xcodebuild -list -package . 2>&1 || echo "Note: xcodebuild -list may not work with Swift Package directly"

    - name: Run tests on iOS Simulator
      run: |
        set -e
        # Try multiple approaches to run iOS tests
        if xcodebuild test -package . -scheme s2j-about-window -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)' -enableCodeCoverage YES 2>&1; then
          echo "Tests passed using xcodebuild with package"
        elif xcodebuild test -scheme s2j-about-window -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)' -enableCodeCoverage YES 2>&1; then
          echo "Tests passed using xcodebuild with scheme"
        else
          echo "Warning: xcodebuild test failed, trying swift test with iOS target..."
          swift test --enable-code-coverage 2>&1 || echo "Note: swift test may not support iOS simulator directly"
          exit 1
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: ios
        name: ios-coverage
        fail_ci_if_error: false

  build-release:
    runs-on: macos-latest
    needs: [test-macos, test-ios]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build Universal Binary
      run: |
        swift build -c release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: s2j-about-window-build
        path: .build/release/
