name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on macOS
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: macos
        name: macos-coverage

  test-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Verify Swift Package
      run: |
        swift package describe --type json | head -20
        swift package resolve

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode Project
      run: |
        if [ -f "project.yml" ]; then
          echo "Generating Xcode project from project.yml..."
          xcodegen generate
          echo "Xcode project generated successfully"
        else
          echo "Error: project.yml not found. Cannot generate Xcode project."
          exit 1
        fi

    - name: List available simulators
      run: |
        echo "Available iOS simulators:"
        xcrun simctl list devices available | grep -i "iOS" || true

    - name: List Xcode schemes
      run: |
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          xcodebuild -list -project s2j-about-window.xcodeproj
        else
          echo "Error: Xcode project not found after generation"
          exit 1
        fi

    - name: Build for iOS (verify compilation)
      run: |
        # Get iOS SDK path
        IOS_SDK_PATH=$(xcrun --show-sdk-path --sdk iphonesimulator)
        echo "iOS SDK Path: $IOS_SDK_PATH"

        # Use generic iOS Simulator destination (works with any available simulator)
        DESTINATION="generic/platform=iOS Simulator"
        echo "Using destination: $DESTINATION"

        # Build with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Building with Xcode project..."
          xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -destination "$DESTINATION" \
            -sdk iphonesimulator
        else
          echo "Error: Xcode project not found. iOS builds require an Xcode project."
          exit 1
        fi

    - name: Run tests on iOS Simulator
      run: |
        set -e
        DESTINATION="generic/platform=iOS Simulator"
        echo "Using destination: $DESTINATION"

        # Run tests with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Running tests with Xcode project..."
          xcodebuild test \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -destination "$DESTINATION" \
            -enableCodeCoverage YES
        else
          echo "Error: Xcode project not found. iOS tests require an Xcode project."
          exit 1
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: ios
        name: ios-coverage
        fail_ci_if_error: false

  build-release:
    runs-on: macos-latest
    needs: [test-macos, test-ios]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build Universal Binary
      run: |
        swift build -c release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: s2j-about-window-build
        path: .build/release/
