name: Swift Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Run tests on macOS
      run: |
        swift test --enable-code-coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: macos
        name: macos-coverage

  test-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Verify Swift Package
      run: |
        swift package describe --type json | head -20
        swift package resolve

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode Project
      run: |
        if [ -f "project.yml" ]; then
          echo "Generating Xcode project from project.yml..."
          xcodegen generate
          echo "Xcode project generated successfully"
        else
          echo "Error: project.yml not found. Cannot generate Xcode project."
          exit 1
        fi

    - name: List available simulators
      run: |
        echo "Available iOS simulators:"
        xcrun simctl list devices available | grep -i "iOS" || true

    - name: Get and Boot iOS Simulator
      id: simulator
      run: |
        # Get available iOS simulators and boot one
        echo "Listing available iOS simulators..."
        xcrun simctl list devices available | grep -i "iPhone\|iPad" | head -10 || true

        # Try to find an iPhone simulator first, then iPad
        SIMULATOR_LINE=$(xcrun simctl list devices available | grep -i "iPhone" | head -1)
        if [ -z "$SIMULATOR_LINE" ]; then
          SIMULATOR_LINE=$(xcrun simctl list devices available | grep -i "iPad" | head -1)
        fi

        if [ -z "$SIMULATOR_LINE" ]; then
          echo "Error: No available iOS simulator found"
          echo "All available devices:"
          xcrun simctl list devices available || true
          exit 1
        fi

        echo "Found simulator line: $SIMULATOR_LINE"

        # Extract UDID
        SIMULATOR_UDID=$(echo "$SIMULATOR_LINE" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)

        # Extract simulator name (e.g., "iPhone 15" or "iPhone 15 Pro")
        # Format: "iPhone 15 (A95FF35F-...) (Available)"
        SIMULATOR_NAME=$(echo "$SIMULATOR_LINE" | sed -E 's/^[[:space:]]*([^(]+) \(.*/\1/' | xargs)

        # Extract OS version from runtime
        # Get the runtime for this device
        DEVICE_TYPE=$(xcrun simctl list devicetypes | grep "$SIMULATOR_NAME" | head -1 | awk -F'[()]' '{print $2}' || echo "")
        if [ -n "$DEVICE_TYPE" ]; then
          RUNTIME=$(xcrun simctl list runtimes available | grep -i "iOS" | head -1 | awk -F'[()]' '{print $2}' || echo "")
          if [ -n "$RUNTIME" ]; then
            OS_VERSION=$(echo "$RUNTIME" | sed 's/com.apple.CoreSimulator.SimRuntime.iOS-//' | sed 's/-.*//')
            echo "Detected OS version: $OS_VERSION"
          fi
        fi

        echo "Found iOS Simulator: $SIMULATOR_NAME (UDID: $SIMULATOR_UDID)"

        # Boot the simulator (if not already booted)
        echo "Booting simulator $SIMULATOR_UDID..."
        xcrun simctl boot "$SIMULATOR_UDID" 2>&1 || echo "Simulator may already be booted"

        # Wait for simulator to be ready
        echo "Waiting for simulator to be ready..."
        sleep 5

        # Verify simulator is booted
        BOOT_STATUS=$(xcrun simctl list devices | grep "$SIMULATOR_UDID" | grep -o "Booted" || echo "")
        if [ -z "$BOOT_STATUS" ]; then
          echo "Warning: Simulator may not be fully booted, but continuing..."
        else
          echo "Simulator is booted and ready"
        fi

        # Try to get destination from xcodebuild after simulator is booted
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Querying xcodebuild for available destinations..."
          echo "Full xcodebuild -showdestinations output:"
          xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>&1 | head -50 || true

          # Try to find destination with name
          if [ -n "$SIMULATOR_NAME" ]; then
            XCODE_DEST=$(xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>/dev/null | grep -i "platform=iOS Simulator" | grep -i "$SIMULATOR_NAME" | head -1)
            if [ -n "$XCODE_DEST" ]; then
              echo "Found destination by name: $XCODE_DEST"
              DEST_STRING=$(echo "$XCODE_DEST" | sed 's/^[[:space:]]*//')
              echo "destination=$DEST_STRING" >> $GITHUB_OUTPUT
            fi
          fi

          # If not found by name, try by UDID
          if [ -z "$XCODE_DEST" ]; then
            XCODE_DEST=$(xcodebuild -project s2j-about-window.xcodeproj -scheme S2JAboutWindow-iOS -showdestinations -sdk iphonesimulator 2>/dev/null | grep "platform=iOS Simulator" | grep "$SIMULATOR_UDID" | head -1)
            if [ -n "$XCODE_DEST" ]; then
              echo "Found destination by UDID: $XCODE_DEST"
              DEST_STRING=$(echo "$XCODE_DEST" | sed 's/^[[:space:]]*//')
              echo "destination=$DEST_STRING" >> $GITHUB_OUTPUT
            fi
          fi

          # If still not found, use name-based destination
          if [ -z "$XCODE_DEST" ] && [ -n "$SIMULATOR_NAME" ]; then
            echo "Using name-based destination as fallback: platform=iOS Simulator,name=$SIMULATOR_NAME"
            echo "destination=platform=iOS Simulator,name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
          elif [ -z "$XCODE_DEST" ]; then
            echo "Using UDID-based destination as fallback: platform=iOS Simulator,id=$SIMULATOR_UDID"
            echo "destination=platform=iOS Simulator,id=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          fi
        else
          # Fallback to name-based or UDID-based destination
          if [ -n "$SIMULATOR_NAME" ]; then
            echo "Using name-based destination (project not found): platform=iOS Simulator,name=$SIMULATOR_NAME"
            echo "destination=platform=iOS Simulator,name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
          else
            echo "Using UDID-based destination (project not found): platform=iOS Simulator,id=$SIMULATOR_UDID"
            echo "destination=platform=iOS Simulator,id=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          fi
        fi

        echo "udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
        echo "name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT

    - name: List Xcode schemes
      run: |
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          xcodebuild -list -project s2j-about-window.xcodeproj
        else
          echo "Error: Xcode project not found after generation"
          exit 1
        fi

    - name: Build for iOS (verify compilation)
      run: |
        # Get iOS SDK path
        IOS_SDK_PATH=$(xcrun --show-sdk-path --sdk iphonesimulator)
        echo "iOS SDK Path: $IOS_SDK_PATH"

        # Use destination from previous step
        DESTINATION="${{ steps.simulator.outputs.destination }}"
        echo "Using destination: $DESTINATION"

        # Build with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Building with Xcode project..."
          # Try with specific destination first
          if xcodebuild build \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -destination "$DESTINATION" \
            -sdk iphonesimulator 2>&1; then
            echo "Build succeeded with specific destination"
          else
            echo "Build failed with specific destination, trying generic destination..."
            # Fallback to generic platform destination
            xcodebuild build \
              -project s2j-about-window.xcodeproj \
              -scheme S2JAboutWindow-iOS \
              -destination "platform=iOS Simulator" \
              -sdk iphonesimulator
          fi
        else
          echo "Error: Xcode project not found. iOS builds require an Xcode project."
          exit 1
        fi

    - name: Run tests on iOS Simulator
      run: |
        # Use destination from previous step
        DESTINATION="${{ steps.simulator.outputs.destination }}"
        echo "Using destination: $DESTINATION"

        # Run tests with Xcode project (should exist after generation step)
        if [ -f "s2j-about-window.xcodeproj/project.pbxproj" ]; then
          echo "Running tests with Xcode project..."
          # Try with specific destination first
          if xcodebuild test \
            -project s2j-about-window.xcodeproj \
            -scheme S2JAboutWindow-iOS \
            -destination "$DESTINATION" \
            -enableCodeCoverage YES 2>&1; then
            echo "Tests succeeded with specific destination"
          else
            echo "Tests failed with specific destination, trying generic destination..."
            # Fallback to generic platform destination
            xcodebuild test \
              -project s2j-about-window.xcodeproj \
              -scheme S2JAboutWindow-iOS \
              -destination "platform=iOS Simulator" \
              -enableCodeCoverage YES
          fi
        else
          echo "Error: Xcode project not found. iOS tests require an Xcode project."
          exit 1
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: .build/coverage/coverage.xml
        flags: ios
        name: ios-coverage
        fail_ci_if_error: false

  build-release:
    runs-on: macos-latest
    needs: [test-macos, test-ios]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build Universal Binary
      run: |
        swift build -c release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: s2j-about-window-build
        path: .build/release/
